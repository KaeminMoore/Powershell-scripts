##Vulnerabilities Remote install tool
##This script will copy over downloaded updates from c:\temp\patches on the local machine to the remote computer's c:\temp directory
##After copying over the installation files for the updates, it will then install the updates on the remote machine.

#Local Source Path for patches
$RootHotfixPath = "C:\temp\Patches\*"
 
$Hotfixes = @('*.msu')
$Servers = Get-Content "C:\temp\Patches\MachineList.txt"

foreach ($Server in $Servers)
{
    Write-Host "Processing $Server..."

    $needsReboot = $False
    $remotePath = "\\$Server\c$\Temp\Patches\"
    
        if( ! (Test-Connection $Server -Count 1 -Quiet)) 
    {
        Write-Warning "$Server is not accessible"
        continue
    }

        if(!(Test-Path $remotePath))
    {
        New-Item -ItemType Directory -Force -Path $remotePath | Out-Null
    }
    
    foreach ($Hotfix in $Hotfixes)
    {
        Write-Host "`thotfix: $Hotfix"
        $HotfixPath = "$RootHotfixPath$Hotfix"

        Copy-Item $RootHotfixpath $remotePath | start-sleep 60 |
        # Run command as SYSTEM via PsExec (-s switch)
        &PsExec -s \\$Server "C:\Temp\Patches\*.msu /quiet /norestart"
        write-host "& C:\Windows\system32\PsExec -s \\$Server wusa C:\Temp\Patches\$Hotfix /quiet /norestart"
        if ($LastExitCode -eq 3010) {
            $needsReboot = $true
        }
        Get-HotFix -Id "$Hotfix" -ComputerName $Server | Select-Object Source,HotfixID,InstalledOn | Out-file c:\temp\patchreports\PatchReport.txt -append
    }

    # Delete local copy of update packages
    #Remove-Item $remotePath -Force -Recurse
}